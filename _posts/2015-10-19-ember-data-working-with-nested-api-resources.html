---
layout:     post
title:      "Ember Data: working with nested API resources"
date:       2015-10-19 07:00:00
author:     "Kevin Soltysiak"
header-img: "img/post-bg-03.jpg"
---

<p>
  If you are using Ember.js, chances are you are also using Ember Data. While it is not the only option for communicating with your backend, it's the golden path: it's included out of the box when creating a new project with ember-cli, mentioned in the guides, and most resources you'll find assumes you're using Ember Data.
</p>

<p>
  ED has been stable for quite some time now, but there is still a few use cases it does not cover out of the box. I'll be exploring one of them in this article: handling APIs with nested resources (eg. JSON APIs with URLs such as <code>/posts/1/comments</code>).
</p>

<p>
  <em>Before I go further: I have dealt recently with the situations mentioned below. As such, code samples were extracted from real-life projects, but edited for the purpose of this article, and may not work exactly as is: they're here mainly to give some substance to the concepts explored.</em>
</p>

<h2 id="urltemplatestotherescue">URL Templates to the rescue</h2>

<p>
  When dealing with such APIs, I used to handroll my own solution, subclassing and overriding <code>buildUrl</code> in my adapters everywhere it was needed. But a few weeks ago, I found the addon <a href="https://github.com/amiel/ember-data-url-templates">ember-data-url-templates</a>.
</p>

<p>
  This addon allows you to specify a URL template that may include dynamic segments for each adapter operation. Then, you need to define methods used to resolve those dynamic segments, and that's it! Here is a basic example, taken from the project's README:
</p>

<script src="https://gist.github.com/ksol/b6d495109ede207c68e2.js"></script>

<p>
  This example shows how to use the model relationships' to build the URL. Pretty neat, right? However, we cannot always rely on the relationships to build the URL, and that's where things gets interesting.
</p>

<h3 id="buildingurlsusingoutsidedata">Building URLs using outside data</h3>

<p>
  In the example above, we see that the methods in <code>urlSegments</code> are given a few arguments: <code>type</code>, <code>id</code>, <code>snapshot</code>, and <code>query</code>. Now, let's say we have a post model, and we want to fetch <em>all</em> its comments, and that unlike our example, we can only fetch them through <code>/posts/{postId}/comments</code>.
</p>

<p>
  In this case, there is no <code>id</code> and <code>snapshot</code> that we can use to extract the <code>postId</code>. The data we need is outside of our reach, so we need to find a way to "pass" it to our adapter.
</p>

<p>
  For this purpose, I decided to use a service object that I call <code>adapterContext</code>. This service is responsible for holding contextual data needed by the adapter, and could be like this:
</p>

<script src="https://gist.github.com/ksol/1d5ef23d3ad7bb0ec0d0.js"></script>

<p>
  This service would be injected in your routes, controllers, adapters, and probably components too. Then, you could use it like this:
</p>

<script src="https://gist.github.com/ksol/4b63a42272ffe8afbd1d.js"></script>

<p>
  And that should work as you expect. Using <code>setContext</code> instead of directly setting the properties on the service ensures that the context data set with a previous call is not kept around, allowing you to not call <code>resetContext</code> every time.
</p>

<h3 id="resourcethatmayormaynotbenested">Resource that may or may not be nested</h3>

<p>
  Now, what if we're dealing with resources that may or not be nested, and nested under different types of parent resources? One such case could be users: you can list them directly (<code>/users</code>), or only want to find users belonging to an organization (<code>/organizations/1/users/</code>), or to a company (<code>/companies/1/users</code>).
</p>

<p>
  It actually is pretty straightforward: you can use computed properties when defining your url templates! You can then check the <code>adapterContext</code> to see which property is present, and choose which URL to use based on that:
</p>

<script src="https://gist.github.com/ksol/648002e30bb102a52ddf.js"></script><h3 id="whatsnext">What's next</h3>

<p>
  <a href="https://github.com/amiel/ember-data-url-templates">ember-data-url-templates</a> is pretty useful and built on solid foundations: URL templates are described in <a href="http://tools.ietf.org/html/rfc6570">RFC 6570</a> and the addon adheres closely to it. It may also land in Ember Data itself one day too, if proven robust and useful enough.
</p>

<p>
  Later this week, I'll explore how Ember Data can leverage ember-data-url-templates to use custom API endpoints (such as <code>/posts/starred</code>), so stay tuned.
</p>

<p>
  As always, I hope this article was useful and clear enough. Feel free to leave a comment, or get in touch via email or twitter if you have any comment or feedback to make.
</p>
